name: build-test

on:
  pull_request:
  push:
    branches: [ "fix/**", "ci/**" ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        run: echo ok

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake jq

      - name: Build core (CMake)
        run: |
          cmake -S packages/core -B packages/core/build
          cmake --build packages/core/build -j

      - name: Smoke test re4_dump
        run: |
          hexdump -n 32 -C packages/core/build/re4_dump | head -n3

      - name: Build client (r4cat)
        run: |
          set -x
          make -j || true
          if test -x bin/r4cat; then
            ls -l bin/r4cat
          else
            echo "r4cat: nothing to build in CI (noop)"
          fi

      - name: Tamper test (if present)
        run: |
          [ -x tests/tamper.sh ] && tests/tamper.sh || echo "skipped (noop)"
