name: re4ctor-ci

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build cmake curl gpg

      # --- build core via cmake/ninja ---
      - name: Build core (CMake)
        run: |
          cd packages/core
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j"$(nproc)"
          file build/re4_dump || true
          ls -l build || true

      # --- smoke test entropy tap ---
      - name: Smoke test re4_dump
        run: |
          cd packages/core/build
          ./re4_dump | head -c 32 | hexdump -C

      # --- build minimal client from Makefile (r4cat_light) ---
      - name: Build client (r4cat)
        run: |
          make -j
          test -x bin/r4cat
          ls -l bin/r4cat

      # --- optional tamper test (won't fail CI if missing) ---
      - name: Tamper test (if present)
        run: |
          if [ -x tests/tamper.sh ]; then
            bash -x tests/tamper.sh
          else
            echo "no tamper.sh -> skipping"
          fi

      # --- generate SBOM with syft ---
      - name: Generate SBOM (SPDX)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sudo sh -s -- -b /usr/local/bin
          cd packages/core
          syft dir:. -o spdx-json > release/SBOM.spdx.json
          test -s release/SBOM.spdx.json
          head -20 release/SBOM.spdx.json || true

      # --- upload build artifacts for auditing / release prep ---
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: re4ctor-build
          path: |
            packages/core/build/re4_dump
            packages/core/release/SBOM.spdx.json
            bin/r4cat
