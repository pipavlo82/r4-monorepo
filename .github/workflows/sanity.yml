name: sanity

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  sanity-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          pip install --no-cache-dir -r api/requirements.txt

      - name: Import smoke test (modules must load)
        run: |
          python - <<'PY'
          import fastapi
          from api import app as _app_check
          from api.sign_ecdsa import ecdsa_sign
          from api.sign_dilithium import PQ_AVAILABLE
          print("PQ_AVAILABLE=", PQ_AVAILABLE)
          PY

      - name: Build Docker image (r4pq test)
        run: |
          docker build -t r4pq-ci-test .

      - name: Run container
        run: |
          set -euo pipefail
          docker run -d \
            --name r4pq-ci-test \
            -p 8081:8081 \
            -e API_KEY='ci-demo' \
            -e RATE_LIMIT='30/minute' \
            r4pq-ci-test
          # give uvicorn a moment to boot
          sleep 1

      - name: Wait until service is ready
        run: |
          set -euo pipefail
          echo "Waiting for service (HTTP 200 on /version)..."
          for i in {1..45}; do
            code="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8081/version || true)"
            if [ "$code" = "200" ]; then
              echo "Service is ready (HTTP $code)"
              exit 0
            fi
            sleep 1
          done
          echo "Service did not become ready (HTTP 200 on /version) in time" >&2
          exit 1

      - name: Fetch and verify /version
        run: |
          set -euo pipefail
          curl -sS http://127.0.0.1:8081/version -o /tmp/version.json
          echo "::group::Service Version Info"
          cat /tmp/version.json
          echo "::endgroup::"

      - name: Smoke test /random_pq?sig=ecdsa
        run: |
          set -euo pipefail
          if curl -sSf "http://127.0.0.1:8081/random_pq?sig=ecdsa" -o /tmp/rand.json; then
            echo "::group::Random PQ Response"
            cat /tmp/rand.json
            echo "::endgroup::"
          else
            echo "::warning::/random_pq?sig=ecdsa endpoint failed or returned error"
          fi

      - name: Cleanup container
        if: always()
        run: |
          docker logs r4pq-ci-test || true
          docker stop r4pq-ci-test || true
          docker rm r4pq-ci-test || true
