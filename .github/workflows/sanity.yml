name: sanity

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  sanity-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          pip install --no-cache-dir -r api/requirements.txt

      - name: Import smoke test (modules must load)
        run: |
          python - <<'PY'
          import fastapi
          from api import app as _app_check
          from api.sign_ecdsa import ecdsa_sign
          from api.sign_dilithium import PQ_AVAILABLE
          print("PQ_AVAILABLE=", PQ_AVAILABLE)
          PY

      - name: Build Docker image (r4pq test)
        run: |
          docker build -t r4pq-ci-test .

      - name: Run container
        run: |
          set -euo pipefail
          docker run -d \
            --name r4pq-ci-test \
            -p 8081:8081 \
            -e API_KEY='ci-demo' \
            -e RATE_LIMIT='30/minute' \
            r4pq-ci-test
          # give uvicorn a moment to boot
          sleep 1

      # --- ключова правка: чекаємо будь-який HTTP-код, а не валимося на 404 ---
      - name: Wait until service is ready
        run: |
          set -euo pipefail
          for i in {1..45}; do
            code="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8081/ || true)"
            if [ "$code" != "000" ]; then
              echo "service responded with HTTP $code"
              exit 0
            fi
            sleep 1
          done
          echo "service did not become ready in time" >&2
          exit 1

      # --- спочатку пробуємо /version; якщо його нема — беремо /openapi.json ---
      - name: Fetch /version or /openapi.json
        run: |
          set -euo pipefail
          code="$(curl -s -o /tmp/version.json -w '%{http_code}' http://127.0.0.1:8081/version || true)"
          if [ "$code" = "200" ] && [ -s /tmp/version.json ]; then
            echo "----- /version -----"
            cat /tmp/version.json
          else
            echo "No /version (HTTP $code). Falling back to /openapi.json"
            curl -sS http://127.0.0.1:8081/openapi.json -o /tmp/openapi.json
            test -s /tmp/openapi.json
            echo "----- /openapi.json (excerpt) -----"
            head -c 400 /tmp/openapi.json; echo
          fi

      # --- м'який запит до /random_pq: не валить job, але покаже результат якщо є ---
      - name: Hit /random_pq?sig=ecdsa (soft)
        run: |
          set -euo pipefail
          if curl -s "http://127.0.0.1:8081/random_pq?sig=ecdsa" -o /tmp/rand.json; then
            if [ -s /tmp/rand.json ]; then
              echo "----- /random_pq?sig=ecdsa -----"
              cat /tmp/rand.json
            else
              echo "random_pq returned empty body"
            fi
          else
            echo "random_pq endpoint not available (soft check)"
          fi

      - name: Cleanup container
        if: always()
        run: |
          docker logs r4pq-ci-test || true
          docker stop r4pq-ci-test || true
          docker rm r4pq-ci-test || true
